"""
Adapted malware modules that capture behavior and send to consumer.
These wrappers prevent actual attacks while preserving traffic patterns.
"""

import json
import time
import random
from datetime import datetime


class MalwareAdapter:
    """Base adapter for capturing malware behavior"""

    def __init__(self, connection):
        self.conn = connection
        self.running = True

    def send_event(self, event_data):
        """Send captured behavior to consumer"""
        try:
            self.conn.sendall((json.dumps(event_data) + "\n").encode())
        except Exception as e:
            print(f"Error sending event: {e}")


class BeaconingAdapter(MalwareAdapter):
    """Adapter for BotNet/Beaconing.py"""

    def run(self):
        """Simulate botnet beaconing behavior"""
        while self.running:
            beacon_interval = random.randint(10, 60)
            bot_id = random.randint(1000, 9999)

            event = {
                "timestamp": time.time(),
                "datetime": datetime.utcnow().isoformat(),
                "malware_type": "botnet_beaconing",
                "source_ip": f"10.0.0.{random.randint(10, 250)}",
                "dest_ip": "consumer",
                "dest_port": 8080,
                "protocol": "HTTP",
                "method": "POST",
                "bot_id": bot_id,
                "status": "online",
                "user_agent": "botnet-victim/1.0",
                "c2_server": "http://consumer:8080/command",
                "beacon_interval": beacon_interval,
                "payload_size": random.randint(100, 500),
            }

            self.send_event(event)
            print(f"[Beaconing] Bot {bot_id} check-in (interval: {beacon_interval}s)")
            time.sleep(beacon_interval)


class C2IRCAdapter(MalwareAdapter):
    """Adapter for BotNet/C2IRC.py"""

    def run(self):
        """Simulate IRC C2 behavior"""
        nickname = f"bot{random.randint(1000, 9999)}"
        channel = "#botnet"

        # Simulate connection
        connect_event = {
            "timestamp": time.time(),
            "datetime": datetime.utcnow().isoformat(),
            "malware_type": "botnet_c2_irc",
            "source_ip": f"10.0.0.{random.randint(10, 250)}",
            "dest_ip": "consumer",
            "dest_port": 6667,
            "protocol": "IRC",
            "action": "CONNECT",
            "nickname": nickname,
            "channel": channel,
            "payload_size": 50,
        }
        self.send_event(connect_event)
        print(f"[C2IRC] Bot {nickname} connected")

        while self.running:
            message_types = ["PRIVMSG", "PING", "PONG"]
            msg_type = random.choice(message_types)

            event = {
                "timestamp": time.time(),
                "datetime": datetime.utcnow().isoformat(),
                "malware_type": "botnet_c2_irc",
                "source_ip": f"10.0.0.{random.randint(10, 250)}",
                "dest_ip": "consumer",
                "dest_port": 6667,
                "protocol": "IRC",
                "action": msg_type,
                "nickname": nickname,
                "channel": channel,
                "message": "ping" if msg_type == "PRIVMSG" else None,
                "payload_size": random.randint(50, 200),
            }

            self.send_event(event)
            print(f"[C2IRC] {nickname} -> {msg_type}")
            time.sleep(random.randint(20, 120))


class FtpBruteForceAdapter(MalwareAdapter):
    """Adapter for BruteForce/FtpBruteForce.py"""

    def simulate(self):
        """Simulate SYN flood attack"""
        burst_size = random.randint(100, 200)
        results = []
        for _ in range(burst_size):
            target_ip = "consumer"

            for idx, pwd in enumerate(passwords):
                event = {
                    "timestamp": time.time(),
                    "datetime": datetime.utcnow().isoformat(),
                    "malware_type": "bruteforce_ftp",
                    "source_ip": f"10.0.0.{random.randint(10, 250)}",
                    "dest_ip": target_ip,
                    "dest_port": 21,
                    "protocol": "FTP",
                    "username": username,
                    "password_attempt": pwd,
                    "attempt_number": idx + 1,
                    "total_attempts": len(passwords),
                    "success": False,
                    "timeout": 3,
                }

                self.send_event(event)
                print(
                    f"[FTP BruteForce] {target_ip}:21 - attempt {idx + 1}/{len(passwords)}"
                )
                time.sleep(random.uniform(0.5, 2.0))

            time.sleep(random.randint(30, 90))


class HTTPBruteForceAdapter(MalwareAdapter):
    """Adapter for BruteForce/HTTPBruteForce.py"""

    def simulate(self):
        """Simulate HTTP brute force attack"""
        usernames = ["admin", "root", "user", "test"]
        passwords = ["password", "123456", "admin", "root", "12345678"]
        results = []
        for idx, (username, pwd) in enumerate(itertools.product(usernames, passwords)):
            target_ip = "consumer"


class SSHBruteForceAdapter(MalwareAdapter):
    """Adapter for BruteForce/SshBruteForce.py"""

    def simulate(self):
        """Simulate SSH brute force attack"""
        usernames = ["admin", "root", "user", "ubuntu"]
        passwords = ["password", "123456", "admin", "root", "12345678"]
        results = []
        for idx, (username, pwd) in enumerate(itertools.product(usernames, passwords)):
            target_ip = "consumer"


class HTTPFloodAdapter(MalwareAdapter):
    """Adapter for ddos/HttpFlood.py"""

    def run(self):
        """Simulate HTTP flood DDoS behavior"""
        user_agents = [
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36",
            "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:96.0) Gecko/20100101 Firefox/96.0",
        ]

        referers = [
            "https://www.google.com/",
            "https://www.facebook.com/",
            "https://www.youtube.com/",
        ]

        while self.running:
            target_ip = "consumer"
            burst_size = random.randint(50, 200)

            print(
                f"[HTTP Flood] Starting burst of {burst_size} requests to {target_ip}"
            )

            for i in range(burst_size):
                method = random.choice(["GET", "POST"])

                event = {
                    "timestamp": time.time(),
                    "datetime": datetime.utcnow().isoformat(),
                    "malware_type": "ddos_http_flood",
                    "source_ip": f"10.0.0.{random.randint(10, 250)}",
                    "dest_ip": target_ip,
                    "dest_port": 80,
                    "protocol": "HTTP",
                    "method": method,
                    "user_agent": random.choice(user_agents),
                    "referer": random.choice(referers),
                    "payload_size": random.randint(200, 1500),
                    "connection_type": "keep-alive",
                    "request_rate": "high",
                    "burst_number": i + 1,
                    "burst_size": burst_size,
                }

                self.send_event(event)
                time.sleep(random.uniform(0.01, 0.1))

            print(f"[HTTP Flood] Burst complete")
            time.sleep(random.randint(10, 30))


class SYNFloodAdapter(MalwareAdapter):
    """Adapter for ddos/SynFlood.py"""

    def run(self):
        """Simulate SYN flood DDoS behavior"""
        while self.running:
            target_ip = "consumer"
            burst_size = random.randint(100, 500)

            print(
                f"[SYN Flood] Starting burst of {burst_size} SYN packets to {target_ip}"
            )

            for i in range(burst_size):
                # Generate spoofed source IP
                spoofed_ip = (
                    f"{random.randint(1, 223)}.{random.randint(0, 255)}."
                    f"{random.randint(0, 255)}.{random.randint(1, 254)}"
                )

                event = {
                    "timestamp": time.time(),
                    "datetime": datetime.utcnow().isoformat(),
                    "malware_type": "ddos_syn_flood",
                    "source_ip": spoofed_ip,
                    "source_port": random.randint(1024, 65535),
                    "dest_ip": target_ip,
                    "dest_port": 80,
                    "protocol": "TCP",
                    "flags": "SYN",
                    "payload_size": 1024,
                    "spoofed_ip": True,
                    "burst_number": i + 1,
                    "burst_size": burst_size,
                }

                self.send_event(event)
                time.sleep(random.uniform(0.001, 0.05))

            print(f"[SYN Flood] Burst complete")
            time.sleep(random.randint(15, 45))


class UDPFloodAdapter(MalwareAdapter):
    """Adapter for ddos/UdpFlood.py"""

    def simulate(self):
        """Simulate UDP flood attack"""
        burst_size = random.randint(100, 200)
        results = []
        for _ in range(burst_size):
            target_ip = "consumer"
            target_port = random.randint(1024, 65535)
            burst_size = random.randint(100, 500)

            print(
                f"[UDP Flood] Starting burst of {burst_size} UDP packets to {target_ip}:{target_port}"
            )

            for i in range(burst_size):
                # Generate spoofed source IP
                spoofed_ip = (
                    f"{random.randint(1, 223)}.{random.randint(0, 255)}."
                    f"{random.randint(0, 255)}.{random.randint(1, 254)}"
                )

                event = {
                    "timestamp": time.time(),
                    "datetime": datetime.utcnow().isoformat(),
                    "malware_type": "ddos_udp_flood",
                    "source_ip": spoofed_ip,
                    "source_port": random.randint(1024, 65535),
                    "dest_ip": target_ip,
                    "dest_port": target_port,
                    "protocol": "UDP",
                    "payload_size": random.randint(128, 1024),
                    "spoofed_ip": True,
                    "burst_number": i + 1,
                    "burst_size": burst_size,
                }

                self.send_event(event)
                time.sleep(random.uniform(0.001, 0.05))

            print(f"[UDP Flood] Burst complete")
            time.sleep(random.randint(15, 45))


class NormalTrafficAdapter(MalwareAdapter):
    """Adapter for normal/benign traffic"""

    def run(self):
        """Simulate normal traffic behavior"""
        while self.running:
            event = {
                "timestamp": time.time(),
                "datetime": datetime.utcnow().isoformat(),
                "malware_type": "normal_traffic",
                "source_ip": f"10.0.0.{random.randint(10, 250)}",
                "dest_ip": "consumer",
                "dest_port": random.choice([80, 443, 8080]),
                "protocol": random.choice(["HTTP", "HTTPS"]),
                "method": "GET",
                "payload_size": random.randint(100, 2000),
                "response_code": random.choice([200, 304]),
                "traffic_class": "benign",
            }

            self.send_event(event)
            time.sleep(random.uniform(1, 5))
